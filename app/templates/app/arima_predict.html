{% extends 'app/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-center">Cryptocurrency Price Prediction (ARIMA)</h2>
                </div>
                <div class="card-body">
                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="symbol">Cryptocurrency Symbol:</label>
                                    <input type="text" class="form-control" id="symbol" name="symbol" 
                                           placeholder="e.g., ETH/USDT" required>
                                    <small class="form-text text-muted">Use forward slash (/) between crypto and fiat, e.g., ETH/USDT, BTC/USDT</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="days">Prediction Period (days):</label>
                                    <select class="form-control" id="days" name="days">
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                        <option value="90">90 days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block">Predict</button>
                                </div>
                            </div>
                        </div>
                    </form>

                    {% if error %}
                    <div class="alert alert-danger">
                        {{ error }}
                    </div>
                    {% endif %}

                    {% if plot_data %}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h3>Historical and Predicted Prices</h3>
                                </div>
                                <div class="card-body">
                                    <div id="priceChart"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h3>Daily Price Predictions</h3>
                                </div>
                                <div class="card-body">
                                    <div id="dailyChart"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Current Price</h3>
                                </div>
                                <div class="card-body">
                                    <h4>${{ current_price|floatformat:2 }}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Predicted Price</h3>
                                </div>
                                <div class="card-body">
                                    <h4>${{ predicted_price|floatformat:2 }}</h4>
                                    <p class="{% if price_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                        Change: {{ price_change|floatformat:2 }}%
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Daily Predictions Table</h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Predicted Price</th>
                                                    <th>Lower Bound</th>
                                                    <th>Upper Bound</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pred in prediction_table %}
                                                <tr>
                                                    <td>{{ pred.date }}</td>
                                                    <td>${{ pred.price }}</td>
                                                    <td>${{ pred.lower }}</td>
                                                    <td>${{ pred.upper }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Model Information</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h4>Model Details</h4>
                                            <p><strong>Model Type:</strong> ARIMA (Autoregressive Integrated Moving Average)</p>
                                            <p><strong>Parameters:</strong> p={{ arima_params.p }}, d={{ arima_params.d }}, q={{ arima_params.q }}</p>
                                            <p><strong>Model Confidence:</strong> {{ model_confidence|floatformat:2 }}%</p>
                                            <p><strong>Prediction Period:</strong> {{ days }} days</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h4>Price Statistics</h4>
                                            <p><strong>Current Price:</strong> ${{ current_price|floatformat:2 }}</p>
                                            <p><strong>Predicted Price:</strong> ${{ predicted_price|floatformat:2 }}</p>
                                            <p><strong>Price Change:</strong> <span class="{% if price_change > 0 %}text-success{% else %}text-danger{% endif %}">{{ price_change|floatformat:2 }}%</span></p>
                                            <p><strong>Prediction Range:</strong> ${{ min_price }} - ${{ max_price }}</p>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <h4>Model Interpretation</h4>
                                            <p>
                                                {% if arima_params.p > arima_params.q %}
                                                    The model shows a stronger autoregressive component (p={{ arima_params.p }}) than moving average component (q={{ arima_params.q }}), suggesting that recent price movements have a significant influence on future predictions.
                                                {% elif arima_params.q > arima_params.p %}
                                                    The model shows a stronger moving average component (q={{ arima_params.q }}) than autoregressive component (p={{ arima_params.p }}), indicating that the model is more responsive to recent shocks in the market.
                                                {% else %}
                                                    The model shows balanced autoregressive (p={{ arima_params.p }}) and moving average (q={{ arima_params.q }}) components, suggesting a stable prediction pattern.
                                                {% endif %}
                                            </p>
                                            <p>
                                                {% if arima_params.d == 0 %}
                                                    The model uses the original price series (d=0), indicating that the price series is already stationary.
                                                {% elif arima_params.d == 1 %}
                                                    The model applies first-order differencing (d=1), suggesting that the price series has a linear trend.
                                                {% else %}
                                                    The model applies second-order differencing (d=2), indicating that the price series has a quadratic trend.
                                                {% endif %}
                                            </p>
                                            <p>
                                                {% if model_confidence > 80 %}
                                                    The model shows high confidence ({{ model_confidence|floatformat:2 }}%) in its predictions, suggesting strong reliability.
                                                {% elif model_confidence > 60 %}
                                                    The model shows moderate confidence ({{ model_confidence|floatformat:2 }}%) in its predictions.
                                                {% else %}
                                                    The model shows lower confidence ({{ model_confidence|floatformat:2 }}%) in its predictions, suggesting higher uncertainty.
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if plot_data %}
<script>
    var plotData = {{ plot_data|safe }};
    var dailyPlotData = {{ daily_plot_data|safe }};
    Plotly.newPlot('priceChart', plotData.data, plotData.layout);
    Plotly.newPlot('dailyChart', dailyPlotData.data, dailyPlotData.layout);
</script>

{% endif %}
{% endblock %} 